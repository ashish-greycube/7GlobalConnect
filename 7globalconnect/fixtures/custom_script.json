[
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Sales Invoice", 
  "modified": "2018-09-21 18:39:54.057175", 
  "name": "Sales Invoice-Client", 
  "script": "frappe.ui.form.on('Sales Invoice Item', {\n    item_code: function(frm,cdt,cdn) {\n        // do your stuff\n        frm.trigger('set_items_commission_rate');\n    }\n});\n\n\nfrappe.ui.form.on(\"Sales Invoice\", {\n    commission_type: function (frm, cdt, cdn) {\n        frm.trigger('set_items_commission_rate');\n    },\n    validate: function (frm, cdt, cdn) {\n        frm.trigger('set_items_commission_rate');\n    },\n    items_add: function (frm, cdt, cdn) {\n        frm.trigger('set_items_commission_rate');\n    },\n\n    set_items_commission_rate: function (frm) {\n        let commission_type_map = {\n            \"Initial Sales\": \"initial_sales_commission\",\n            \"Yearly Renewal\": \"yearly_renewal_commission\",\n            \"Referral Fees- Initial Sales\": \"referral_fees\"\n        }\n\n\n        frm.add_fetch(\"item_code\", commission_type_map[frm.doc.commission_type], \"commission_rate\");\n            let items = $.map(frm.doc.items, function (i) { return i.item_code });\n            frappe.call({\n                method: \"frappe.client.get_list\",\n                args: {\n                    doctype: \"Item\",\n                    filters: {\n                        \"item_code\": [\"in\", items.join(', ')],\n                    },\n                    fields: [\"initial_sales_commission\", \"yearly_renewal_commission\", \"referral_fees\", \"item_code\"],\n                },\n            }).then(function (r) {\n                if (r.message) {\n                    let total_commission = 0;\n                    let total_base_net = 0;\n                    for (let d of frm.doc.items) {\n                        let item = r.message.filter(function (i) { return i.item_code == d.item_code });\n                        d.commission_rate = flt(item[0][commission_type_map[frm.doc.commission_type]]);\n                        total_commission += flt(d.base_net_amount) * flt(d.commission_rate / 100);\n                        total_base_net +=flt(d.base_net_amount)\n                    }\n                    frm.refresh_field(\"items\");\n                    frm.set_value(\"total_commission\", total_commission);\n                    frm.set_value(\"commission_rate\",flt((total_commission/total_base_net)*100,1));                    \n                }\n            });\n    }\n});", 
  "script_type": "Client"
 }
]